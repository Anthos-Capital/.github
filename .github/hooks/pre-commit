#!/bin/bash

LOCAL_BRANCH_NAME="$(git rev-parse --abbrev-ref HEAD)"

# Constants
BRANCH_PREFIX_SEPARATOR="/"
COMMON_LIST_SEPARATOR="|"
ALLOWED_PREFIXES="feature|bugfix|hotfix|release|support"

# Skip validation for protected branches
PROTECTED_BRANCHES="develop|main|staging"
if [[ "$LOCAL_BRANCH_NAME" =~ ^($PROTECTED_BRANCHES)$ ]]; then
    exit 0
fi

# Validate branch prefix
if [[ ! "$LOCAL_BRANCH_NAME" =~ ^(release$BRANCH_PREFIX_SEPARATOR.*|($ALLOWED_PREFIXES)$BRANCH_PREFIX_SEPARATOR#[0-9]+-.*$) ]]; then
    echo -e "\033[31m ERROR\033[0m Invalid branch name format."
    echo -e "Branch names must follow these patterns:"
    echo -e "- For release branches: release/[description]"
    echo -e "- For other branches: (${ALLOWED_PREFIXES})/#[issue_number]-[description]"
    echo -e "Examples:"
    echo -e "- release/v1.0.0"
    echo -e "- feature/#123-add-new-button"
    echo -e "Use: git branch -m \$(git branch --show-current) new-branch-name"
    exit 1
fi

echo 'ğŸš§ğŸ‘·â€â™‚ï¸ Styling, testing and building your project before committing'

# Check if yarn.lock exists to determine if we're in a JavaScript/TypeScript project
if [ -f "yarn.lock" ]; then
    # Check tsconfig standard if it exists
    if [ -f "tsconfig.json" ]; then
        yarn check-types || (
            echo 'âš ï¸âš ï¸ Failed Type check. âš ï¸âš ï¸'
            false;
        )
    fi

    # Format code if prettier is available
    if [ -f ".prettierrc" ] || [ -f ".prettierrc.js" ] || [ -f ".prettierrc.json" ]; then
        yarn format || (
            echo 'âš ï¸âš ï¸ Failed Prettier format. âš ï¸âš ï¸'
            false;
        )

        yarn check-format || (
            echo 'ğŸ–Œï¸âš ï¸ğŸ–Œï¸ Prettier Format Failed. Run yarn format, add changes and try commit again. ğŸ–Œï¸âš ï¸ğŸ–Œï¸'
            false;
        )
    fi

    # Check ESLint if .eslintrc exists
    if [ -f ".eslintrc" ] || [ -f ".eslintrc.js" ] || [ -f ".eslintrc.json" ]; then
        yarn lint || (
            echo 'ğŸ”âš ï¸ğŸ” ESLint Check Failed. Run yarn lint, add changes and try commit again. ğŸ”âš ï¸ğŸ”'
            false;
        )
    fi

    # Run lint-staged if configured
    if [ -f ".lintstagedrc" ] || [ -f ".lintstagedrc.js" ] || [ -f ".lintstagedrc.json" ]; then
        npx lint-staged || (
            echo 'ğŸš¨ğŸš¨ğŸš¨ Lint-staged failed. Fix the errors and try commit again. ğŸš¨ğŸš¨ğŸš¨'
            false;
        )
    fi

    # Check if build script exists and run it
    if grep -q '"build":' package.json; then
        echo 'âŒ›âŒ›âŒ› ... Alright... Code looks good to me... Trying to build now. âŒ›âŒ›âŒ›'
        yarn build || (
            echo 'ğŸš¨ğŸš¨ğŸš¨ Build Failed. Fix the errors and try commit again. ğŸš¨ğŸš¨ğŸš¨'
            false;
        )
    else
        echo 'âš ï¸âš ï¸ Build script not found in package.json. Skipping build step. âš ï¸âš ï¸'
    fi
fi

# If everything passes, allow the commit
echo 'âœ…âœ…âœ… Congrats! I am committing this right now. âœ…âœ…âœ…'